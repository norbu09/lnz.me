<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>puppet and gitosis (startup automation 1) &#8211; Lenz Gschwendtner</title>
<meta name="description" content="Startup automation became a big buzz currently but I think it has always been key to those who were successful. The speed to market is important and this is not only true for small companies.">
<meta name="keywords" content="post">

<!-- Twitter Cards -->
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://lnz.me/images/site-logo.png">
<meta name="twitter:title" content="puppet and gitosis (startup automation 1)">
<meta name="twitter:description" content="Startup automation became a big buzz currently but I think it has always been key to those who were successful. The speed to market is important and this is not only true for small companies.">
<meta name="twitter:creator" content="@norbu09">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="puppet and gitosis (startup automation 1)">
<meta property="og:description" content="Startup automation became a big buzz currently but I think it has always been key to those who were successful. The speed to market is important and this is not only true for small companies.">
<meta property="og:url" content="http://lnz.me/articles/gitosis-and-puppet-setup-startupautomation/">
<meta property="og:site_name" content="Lenz Gschwendtner">





<link rel="canonical" href="http://lnz.me/articles/gitosis-and-puppet-setup-startupautomation/">
<link href="http://lnz.me/feed.xml" type="application/atom+xml" rel="alternate" title="Lenz Gschwendtner Feed">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="http://lnz.me/assets/css/main.min.css">
<!-- Webfonts -->
<script src="//use.edgefonts.net/source-sans-pro:n2,i2,n3,i3,n4,i4,n6,i6,n7,i7,n9,i9;source-code-pro:n4,n7;volkhov.js"></script>

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="http://lnz.me/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://lnz.me/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://lnz.me/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://lnz.me/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://lnz.me/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://lnz.me/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://lnz.me/images/apple-touch-icon-144x144-precomposed.png">

</head>

<body id="post">

<div class="navigation-wrapper">
	<nav role="navigation" id="site-nav" class="animated drop">
	    <ul>
	        
			<li>
				
					<a href="http://lnz.me/about/">About</a>
				 
			</li>
	        
			<li>
				
					<a href="http://lnz.me/articles/">Articles</a>
				 
			</li>
	        
	        <li><a href="http://lnz.me/feed.xml" title="Atom/RSS feed"><i class="icon-rss"></i> Feed</a></li>
	        <li class="dosearch"><i class="icon-search"></i> Search</li>
            <li><a href="http://lnz.me/now/" title="current priorities"> Now</a></li>
	    </ul>
	</nav>
</div><!-- /.navigation-wrapper -->

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->

<div class="search-wrapper">
	<div class="search-form">
		<input type="text" class="search-field" placeholder="Search...">
		<i class="icon-remove-sign icon-2x"></i>
		<ul class="search-results post-list"></ul><!-- /.search-results -->
	</div><!-- /.search-form -->
</div><!-- ./search-wrapper -->

<header class="masthead">
	<div class="wrap">
        
    		<a href="http://lnz.me/" class="site-logo" rel="home" title="Lenz Gschwendtner"><img src="http://lnz.me/images/site-logo.png" width="200" height="200" alt="Lenz Gschwendtner logo" class="animated fadeInUp"></a>
        
        <h1 class="site-title animated fadeIn"><a href="http://lnz.me/">Lenz Gschwendtner</a></h1>
		<h2 class="site-description animated fadeIn" itemprop="description">geek, mentor, punk</h2>
	</div>
</header><!-- /.masthead -->


<div id="main" role="main">
  <article class="hentry">
    
    <div class="entry-wrapper">
      <header class="entry-header">
        <span class="entry-tags"><a href="http://lnz.me/tags/#post" title="Pages tagged post">post</a></span>
        
          <h1 class="entry-title">puppet and gitosis (startup automation 1)</h1>
        
      </header>
      <footer class="entry-meta">
        <img src="http://lnz.me/images/site-logo.png" alt="Lenz Gschwendtner photo" class="author-photo">
        <span class="author vcard">By <span class="fn"><a href="http://lnz.me/about/" title="About Lenz Gschwendtner">Lenz Gschwendtner</a></span></span>
        <span class="entry-date date published"><time datetime="2009-06-10T00:00:00+12:00"><i class="icon-calendar-empty"></i> June 10, 2009</time></span>
        <span class="entry-date date modified"><time datetime="2009-06-10"><i class="icon-pencil"></i> June 10, 2009</time></span>
        
        <span><a href="http://lnz.me/articles/gitosis-and-puppet-setup-startupautomation/" rel="bookmark" title="puppet and gitosis (startup automation 1)"><i class="icon-link"></i> Permalink</a></span>
        
        <span class="social-share-facebook">
            <a href="https://www.facebook.com/sharer/sharer.php?u=http://lnz.me/articles/gitosis-and-puppet-setup-startupautomation/" title="Share on Facebook" itemprop="Facebook"><i class="icon-facebook-sign"></i> Like</a></span>
        <span class="social-share-twitter">
            <a href="https://twitter.com/intent/tweet?hashtags=articles&text=puppet and gitosis (startup automation 1)&url=http://lnz.me/articles/gitosis-and-puppet-setup-startupautomation/&via=norbu09" title="Share on Twitter" itemprop="Twitter"><i class="icon-twitter-sign"></i> Tweet</a></span>
        <span class="social-share-googleplus">
            <a href="https://plus.google.com/share?url=http://lnz.me/articles/gitosis-and-puppet-setup-startupautomation/" title="Share on Google Plus" itemprop="GooglePlus"><i class="icon-google-plus-sign"></i> +1</a></span>
            <!-- /.social-share -->
      </footer>
      <div class="entry-content">
        <h1 id="startup-automation---part-1">Startup automation - Part 1</h1>

<p>Startup automation became a big buzz currently but I think it has always
been key to those who were successful. The speed to market is important
and this is not only true for small companies.</p>

<p>Enough marketing blurb. Truth is we tech guys are lazy and that is a
good habit. Laziness keeps us creative in terms of minimising tasks we
have to do and that means in automating stuff. When you (as the tech
guy) grow a company there are many things only you know and can do. This
is normal. One day your marketing guy wants to release new content not
only once but 5 times and you start to think about a real rollout
process. Tis is not exactly new technology but it keeps you busy for a
while and there is a surprising lack of good tutorials out there.</p>

<p>I played with puppet and gitosis the other day to automate parts of our
environment and came up with the following setup. It runs on a slicehost
slice on debian - being a freebsd and mac guy I can confirm the setup is
not too different on those platforms either :-)</p>

<h2 id="gitosis">gitosis</h2>

<p>gitosis is a git hosting platform that uses virtual users and is managed
entirely with git hooks. This is nice as you simply check out the master
repository and add users and repositories there. Really simple, really
effective.
It looks like there is exactly one post in the wild that describes
gitosis setup and that is from 2007 (<a href="http://scie.nti.st/2007/11/14/hosting-git-repositories-the-easy-and-secure-way" title="scie.nti.st">scie.nti.st</a>)</p>

<p>First important thing here is a ssh key. You should have one and used to
use it. If you never heard of ssh keys do your homework first!</p>

<p>The last part of your ssh key is normally username@host. Edit that one
to be only your preferred username - this identifier will be the
reference in your gitosis config for your user.</p>

<p>I started playing with gitosis and came up with the following order:
- install gitosis from your preferred package management system (ports,
  apt, …)
- copy your ssh public key /tmp on the gitosis host
- initialize the repository</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh">  <span class="nv">$ </span>sudo -H -u gitosis gitosis-init &lt; /tmp/id_dsa.pub
  </code></pre></figure>

<ul>
  <li>clone the new master repository</li>
</ul>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh">  <span class="nv">$ </span>git clone gitosis@GITHOST:gitosis-admin.git
  </code></pre></figure>

<ul>
  <li>edit gitosis.conf</li>
</ul>

<figure class="highlight"><pre><code class="language-ini" data-lang="ini">  <span class="nn">[group admin]</span>
  <span class="py">members</span> <span class="p">=</span> <span class="s">YOURNAME</span>
  <span class="py">writable</span> <span class="p">=</span> <span class="s">puppet</span>
  </code></pre></figure>

<ul>
  <li>add the gitosis.conf and commit and push</li>
  <li>you have successfully created your first step in a working gitosis
setup</li>
  <li>create a local repository called puppet (git init …)</li>
  <li>tell the git repository where your gitosis server is</li>
</ul>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh">  <span class="nv">$ </span>git remote add origin gitosis@GITHOST:puppet.git
  </code></pre></figure>

<ul>
  <li>touch a file (you need to have something in the repository to commit)</li>
  <li>add and commit the file</li>
  <li>push the repository to the gitosis server</li>
</ul>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh">  <span class="nv">$ </span>git push origin master:refs/heads/master
  </code></pre></figure>

<p>After this you have two things - a master gitosis repository for your
git server management and a local puppet repository for your future
puppet setup. This puppet setup does not do anything yet so lets wire
that one up to your puppetmaster. For simplicity I assume that the
gitosis server will also be your puppetmaster. Once the underlying
concept is understood you can easily change the puppetmaster to any
other host by only changing the post commit hook in the according git
repository.</p>

<h2 id="puppet">puppet</h2>

<p>Till now we did not bother finding the filesystem location of our new
gitosis setup. Now we need some git hooks in the puppet repository and
we have to find it. Under debain you can find the gitosis repository
structure in <code class="highlighter-rouge">/srv/gitosis</code> and our puppet repository under
<code class="highlighter-rouge">/srv/gitosis/repositories/puppet.git</code>.</p>

<p>I started out by creating a <code class="highlighter-rouge">bin</code> directory for the gitosis user as I
expect to share some code between different hooks. There will be many
“check out this repo to this working directory” hooks for various
purposes. The first script is very basic and does nothing fancy - we can
beef it up later on as we go.</p>

<p><code class="highlighter-rouge">/srv/gitosis/bin/update.sh</code></p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="c">#!/bin/sh</span>
<span class="nb">umask </span>002

<span class="nv">PFAD</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">CURR</span><span class="o">=</span><span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>
<span class="nb">cd</span> <span class="k">${</span><span class="nv">PFAD</span><span class="k">}</span>

env -i /usr/bin/git-pull origin master
env -i git-update-server-info
<span class="nb">cd</span> <span class="k">${</span><span class="nv">CURR</span><span class="k">}</span></code></pre></figure>

<p>This simple script takes one argument which is the destination path and
doe a git pull there. Very generic and not too secure but it does the
trick for the beginning.</p>

<p>Now we need to make this script executable and add it to the
post-receive git hook in the puppet repository. Go to
<code class="highlighter-rouge">/srv/gitosis/repositories/puppet.git/hooks</code> and edit the <code class="highlighter-rouge">post-receive</code>
hook. We only need the following line in there for the moment:</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh">~/bin/update.sh /etc/puppet</code></pre></figure>

<p>This calls our shiny update script we wrote moments ago. Make sure the
hook script is executable. Now we start setting up puppet. Make sure you
installed puppetmasterd via your favorite package management system. In case you
have a working puppet setup already make sure you back up all your
configuration files. I assume there is nothing here yet and we can axe
the existing stuff and start from scratch.</p>

<p>Remove the existing <code class="highlighter-rouge">/etc/puppet</code> directory and clone our repository
here.</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="gp">$ </span><span class="nb">cd</span> /etc
<span class="gp">$ </span>rm -rf puppet
<span class="gp">$ </span>git clone /srv/gitosis/repositories/puppet.git
<span class="gp">$ </span>chmod -R g+w puppet</code></pre></figure>

<p>Now we have to modify two hooks to make sure we fix permissions. This is
a ugly hack and only gets us started for now - this should really be
done nicer later on. Edit in the puppet directory under <code class="highlighter-rouge">.git/hooks</code> the
file <code class="highlighter-rouge">post-merge</code> and add the following:</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="c">#!/bin/sh</span>

<span class="nb">echo</span> <span class="s2">"granting rights in </span><span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span><span class="s2">"</span>
sudo chown -R root:root /etc/puppet</code></pre></figure>

<p>To make this work you need to make sure that the gitosis user is in your
sodoers file and of course that sudo is installed. Make this file
executable and copy it to the <code class="highlighter-rouge">post-checkout</code> hook.</p>

<p>Nearly there, test it now and see if you get errors when you push puppet
configuration to the server. If all goes well you should see the puppet
config hitting your <code class="highlighter-rouge">/etc/puppet</code> directory on the server right after
you pushed your local repository.</p>

<p>How to set up a basic puppet infrastructure will be covered in the next
part of this series. Stay tuned …</p>


        
      </div><!-- /.entry-content -->
    </div><!-- /.entry-wrapper -->
    <nav class="pagination" role="navigation">
      
        <a href="http://lnz.me/articles/many-of-us-know-it/" class="btn" title="many of us know it ...">Previous article</a>
      
      
        <a href="http://lnz.me/articles/puppet-basics-startautomation/" class="btn" title="puppet basics (startup automation 2)">Next article</a>
      
    </nav><!-- /.pagination -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2016 Lenz Gschwendtner. Powered by <a href="http://jekyllrb.com">Jekyll</a> using the <a href="http://mademistakes.com/so-simple/">So Simple Theme</a>.</span>
<div class="social-icons">
	<a href="http://twitter.com/norbu09" title="Lenz Gschwendtner on Twitter" target="_blank"><i class="icon-twitter icon-2x"></i></a>
	
	
	<a href="http://linkedin.com/in/lenzgschwendtner" title="Lenz Gschwendtner on LinkedIn" target="_blank"><i class="icon-linkedin icon-2x"></i></a>
	
	
	
	<a href="http://github.com/norbu09" title="Lenz Gschwendtner on Github" target="_blank"><i class="icon-github icon-2x"></i></a>
	
    <a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/80x15.png" /></a>
</div><!-- /.social-icons -->

  </footer>
</div><!-- /.footer-wrapper -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://lnz.me/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://lnz.me/assets/js/scripts.min.js"></script>

<!-- Jekyll Simple Search option -->
<script>
  $(document).ready(function() {
      $('.search-field').simpleJekyllSearch({
          jsonFile : 'http://lnz.me/search.json',
          searchResults : '.search-results',
          template : '<li><article><a href="{url}">{title} <span class="entry-date"><time datetime="{date}">{shortdate}</time></span></a></article></li>',
          noResults: '<p>Nothing found.</p>'
        });
  });

  (function( $, window, undefined ) {
    
     var bs = {
          close: $(".icon-remove-sign"),
          searchform: $(".search-form"),
          canvas: $("body"),
          dothis: $('.dosearch')
      };
    
    bs.dothis.on('click', function() {
      $('.search-wrapper').css({ display: "block" });
      bs.searchform.toggleClass('active');
      bs.searchform.find('input').focus();
      bs.canvas.toggleClass('search-overlay');
    });
    
      bs.close.on('click', function() {
        $('.search-wrapper').removeAttr( 'style' );
        bs.searchform.toggleClass('active');
        bs.canvas.removeClass('search-overlay');
    });
  })( jQuery, window );
</script>


<!-- Asynchronous Google Analytics snippet -->
<script>
  var _gaq = _gaq || [];
  var pluginUrl = 
 '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', 'UA-9729535-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

	        

</body>
</html>
