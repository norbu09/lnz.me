<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>git via HTTP (startup automation 3) &#8211; Lenz Gschwendtner</title>
<meta name="description" content="To enable read only repositories via HTTP is pretty straight forward. I'll cover the basic setup based on nginx and our previously discussed gitosis setup here.">
<meta name="keywords" content="post">

<!-- Twitter Cards -->
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://lnz.me/images/site-logo.png">
<meta name="twitter:title" content="git via HTTP (startup automation 3)">
<meta name="twitter:description" content="To enable read only repositories via HTTP is pretty straight forward. I'll cover the basic setup based on nginx and our previously discussed gitosis setup here.">
<meta name="twitter:creator" content="@norbu09">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="git via HTTP (startup automation 3)">
<meta property="og:description" content="To enable read only repositories via HTTP is pretty straight forward. I'll cover the basic setup based on nginx and our previously discussed gitosis setup here.">
<meta property="og:url" content="http://lnz.me/articles/git-via-HTTP-(startup-automation-3)/">
<meta property="og:site_name" content="Lenz Gschwendtner">





<link rel="canonical" href="http://lnz.me/articles/git-via-HTTP-(startup-automation-3)/">
<link href="http://lnz.me/feed.xml" type="application/atom+xml" rel="alternate" title="Lenz Gschwendtner Feed">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="http://lnz.me/assets/css/main.min.css">
<!-- Webfonts -->
<script src="//use.edgefonts.net/source-sans-pro:n2,i2,n3,i3,n4,i4,n6,i6,n7,i7,n9,i9;source-code-pro:n4,n7;volkhov.js"></script>

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="http://lnz.me/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://lnz.me/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://lnz.me/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://lnz.me/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://lnz.me/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://lnz.me/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://lnz.me/images/apple-touch-icon-144x144-precomposed.png">

</head>

<body id="post">

<div class="navigation-wrapper">
	<nav role="navigation" id="site-nav" class="animated drop">
	    <ul>
	        
			<li>
				
					<a href="http://lnz.me/about/">About</a>
				 
			</li>
	        
			<li>
				
					<a href="http://lnz.me/articles/">Articles</a>
				 
			</li>
	        
	        <li><a href="http://lnz.me/feed.xml" title="Atom/RSS feed"><i class="icon-rss"></i> Feed</a></li>
	        <li class="dosearch"><i class="icon-search"></i> Search</li>
	    </ul>
	</nav>
</div><!-- /.navigation-wrapper -->

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->

<div class="search-wrapper">
	<div class="search-form">
		<input type="text" class="search-field" placeholder="Search...">
		<i class="icon-remove-sign icon-2x"></i>
		<ul class="search-results post-list"></ul><!-- /.search-results -->
	</div><!-- /.search-form -->
</div><!-- ./search-wrapper -->

<header class="masthead">
	<div class="wrap">
        
    		<a href="http://lnz.me/" class="site-logo" rel="home" title="Lenz Gschwendtner"><img src="http://lnz.me/images/site-logo.png" width="200" height="200" alt="Lenz Gschwendtner logo" class="animated fadeInUp"></a>
        
        <h1 class="site-title animated fadeIn"><a href="http://lnz.me/">Lenz Gschwendtner</a></h1>
		<h2 class="site-description animated fadeIn" itemprop="description">geek, mentor, punk</h2>
	</div>
</header><!-- /.masthead -->


<div id="main" role="main">
  <article class="hentry">
    
    <div class="entry-wrapper">
      <header class="entry-header">
        <span class="entry-tags"><a href="http://lnz.me/tags/#post" title="Pages tagged post">post</a></span>
        
          <h1 class="entry-title">git via HTTP (startup automation 3)</h1>
        
      </header>
      <footer class="entry-meta">
        <img src="http://lnz.me/images/site-logo.png" alt="Lenz Gschwendtner photo" class="author-photo">
        <span class="author vcard">By <span class="fn"><a href="http://lnz.me/about/" title="About Lenz Gschwendtner">Lenz Gschwendtner</a></span></span>
        <span class="entry-date date published"><time datetime="2009-08-02T00:00:00+12:00"><i class="icon-calendar-empty"></i> August 02, 2009</time></span>
        <span class="entry-date date modified"><time datetime="2009-08-02"><i class="icon-pencil"></i> August 02, 2009</time></span>
        
        <span><a href="http://lnz.me/articles/git-via-HTTP-(startup-automation-3)/" rel="bookmark" title="git via HTTP (startup automation 3)"><i class="icon-link"></i> Permalink</a></span>
        
        <span class="social-share-facebook">
            <a href="https://www.facebook.com/sharer/sharer.php?u=http://lnz.me/articles/git-via-HTTP-(startup-automation-3)/" title="Share on Facebook" itemprop="Facebook"><i class="icon-facebook-sign"></i> Like</a></span>
        <span class="social-share-twitter">
            <a href="https://twitter.com/intent/tweet?hashtags=articles&text=git via HTTP (startup automation 3)&url=http://lnz.me/articles/git-via-HTTP-(startup-automation-3)/&via=norbu09" title="Share on Twitter" itemprop="Twitter"><i class="icon-twitter-sign"></i> Tweet</a></span>
        <span class="social-share-googleplus">
            <a href="https://plus.google.com/share?url=http://lnz.me/articles/git-via-HTTP-(startup-automation-3)/" title="Share on Google Plus" itemprop="GooglePlus"><i class="icon-google-plus-sign"></i> +1</a></span>
            <!-- /.social-share -->
      </footer>
      <div class="entry-content">
        <h1 id="startup-automation---part-3">Startup automation - Part 3</h1>

<h2 id="git-via-http-with-nginx">git via HTTP with nginx</h2>

<p>Just in case you don’t know (very unlikely) or never played with nginx
before. This is <em>the</em> web server and frontend HTTP loadbalancer all your
HTTP based setups should have anyway. There is documentation in English
on the nginx wiki (<a href="http://wiki.nginx.org">http://wiki.nginx.org</a>) 
and if you get stuck there is a lot of stuff just on google. The rails
community love nginx and they tend to document well - a thanks at this
point to those guys.</p>

<p>The setup is really straight forward but has some minor cave eats that
can cause you grief and debugging hours I want to save you.</p>

<p>First of all you need nginx installed on your system - obviously. I
assume that your webroot is under <code>/var/www</code>. We need a directory called
<code>git</code> under it and need to link the repositories in that you want to
share.</p>

<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>mkdir /var/www/git
<span class="nv">$ </span><span class="nb">cd</span> /var/www/git
<span class="nv">$ </span>ln -s /srv/gitosis/repositories/<span class="o">[</span>repository<span class="o">]</span>.git <span class="o">[</span>repository<span class="o">]</span></code></pre></div>

<p>This includes some assumptions. I take that you have more repositories
in your gitosis setup than public repositories you want to share or make
available via http. If this is not the case you can simply point nginx
at your gitosis repository path and add a simple rewrite rule that cuts
off the trailing <code>.git</code> of the repository path.</p>

<p>In nginx we need some configuration that acually serves those
repositories now. That is initially really straight forward:</p>

<div class="highlight"><pre><code class="language-sh" data-lang="sh">server <span class="o">{</span>
    listen   80<span class="p">;</span>
    server_name  git.<span class="o">[</span>your.domain.tld<span class="o">]</span><span class="p">;</span>
    access_log  /var/log/nginx/git.access.log<span class="p">;</span>
    location / <span class="o">{</span>
        root   /var/www/git/<span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div>

<p>This is the first very basic configuration for nginx. All we have to do
now is enabling a simple hook in our git repository we want to serve
and we are done.</p>

<p>To do that we need to go to our gitosis repository (you can simply <code>cd</code> to
the linked directory now) and edit the <code>hooks/post-update</code> hook. Add the
following line (or uncomment it) and make sure the file has the
executable bit set (<code>chmod +x hooks/post-update</code>).</p>

<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nb">exec </span>git-update-server-info</code></pre></div>

<p>This post update hook needs to be run once now. You can either push
something to the repository to trigger the hook or <code>su</code> to the git user
and simply run the hook. The <code>su</code> is important to not screw up the
permissions.</p>

<p>Speaking of permissions - we need to make the repository readable by the
nginx user. The easy way is to add <code>www-data</code> to the git group that owns
the git repository. The git group should only have read access to the
git repositories anyway so it does not open up a too big hole in your
security.</p>

<p>Once all that is done you can test your setup with the following
command:</p>

<div class="highlight"><pre><code class="language-sh" data-lang="sh">git ls-remote
http://git.<span class="o">[</span>your.domain.tld<span class="o">]</span>/<span class="o">[</span>repository<span class="o">]</span> master</code></pre></div>

<p>This should come back with something like this:</p>

<p><code>171bb2f12ceb908fd4802857a2f577a1739f8d1f        refs/heads/master</code></p>

<h2 id="securing-the-setup-with-basic-auth-and-https">Securing the setup with “basic auth” and HTTPS</h2>

<p>Now comes the fun part. After we have this setup up and running we can
start to use it for rollout systems like capistrano and have read only
repositories that we serve via HTTPS and basic auth without the need of
deploying SSH keys all over for access to gitosis.</p>

<p>All we have to do now is change our nginx configuration slightly. We
need to enable HTTPS and we can even have different auth files for
different projects. This might be interesting if you run several
projects on your gitosis host with different committers.  </p>

<div class="highlight"><pre><code class="language-sh" data-lang="sh">server <span class="o">{</span>
    listen   443<span class="p">;</span>
    server_name  git.<span class="o">[</span>your.domain.tld<span class="o">]</span><span class="p">;</span>
    access_log  /var/log/nginx/git.access.log<span class="p">;</span>

    ssl  on<span class="p">;</span>
    ssl_certificate  certs/git.pem<span class="p">;</span>
    ssl_certificate_key  certs/git.key<span class="p">;</span>

    ssl_session_timeout  5m<span class="p">;</span>

    ssl_protocols  SSLv2 SSLv3 TLSv1<span class="p">;</span>
    ssl_ciphers  ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP<span class="p">;</span>
    ssl_prefer_server_ciphers   on<span class="p">;</span>

    location / <span class="o">{</span>
        root   /var/www/git/<span class="p">;</span>
        auth_basic            <span class="s2">&quot;Restricted&quot;</span><span class="p">;</span>
        auth_basic_user_file  conf.d/htpasswd.general<span class="p">;</span>
    <span class="o">}</span>

    location /<span class="o">[</span>repository 1<span class="o">]</span> <span class="o">{</span>
        root   /var/www/git/<span class="p">;</span>
        autoindex  on<span class="p">;</span>
        auth_basic            <span class="s2">&quot;Restricted&quot;</span><span class="p">;</span>
        auth_basic_user_file  conf.d/htpasswd.<span class="o">[</span>group 1<span class="o">]</span><span class="p">;</span>
    <span class="o">}</span>
    location /<span class="o">[</span>repository 2<span class="o">]</span> <span class="o">{</span>
        root   /var/www/git/<span class="p">;</span>
        autoindex  on<span class="p">;</span>
        auth_basic            <span class="s2">&quot;Restricted&quot;</span><span class="p">;</span>
        auth_basic_user_file  conf.d/htpasswd.<span class="o">[</span>group 2<span class="o">]</span><span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div>

<p>Reload your nginx and you have your repositories served up under HTTPS
and only need to create the htaccess files now. This is simply done with
the <code>htaccess</code> program that is part of apache (or the apache utils with
come as a separate package).
Also note that your <code>root</code> directory is always the base git webroot.</p>

<h2 id="some-oddities">some oddities</h2>

<p>While testing I used self signed certificates and as the host is only
used in non public ways I will stay with them. This caused some googling
however as git came up with the following error:</p>

<p><code>fatal: https://[user:pass@git.host]/[repository]/info/refs download error - SSL certificate problem, verify that the CA cert is OK. </code></p>

<p>This is due to the self signed cert and has to be overridden with a
environment variable. A simple</p>

<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span><span class="nb">export </span><span class="nv">GIT_SSL_NO_VERIFY</span><span class="o">=</span><span class="nb">true</span></code></pre></div>

<p>did the trick. If you have a rollout user you want this parameter to be
in his <code>.profile</code> or your shell specific equivalent (eg <code>.bashrc</code>).</p>


        
      </div><!-- /.entry-content -->
    </div><!-- /.entry-wrapper -->
    <nav class="pagination" role="navigation">
      
        <a href="http://lnz.me/articles/RabbitMQ-talk-at-erlounge/" class="btn" title="RabbitMQ talk at erlounge">Previous article</a>
      
      
        <a href="http://lnz.me/articles/simple-ssh-tunnel-script/" class="btn" title="simple ssh tunnel script">Next article</a>
      
    </nav><!-- /.pagination -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2015 Lenz Gschwendtner. Powered by <a href="http://jekyllrb.com">Jekyll</a> using the <a href="http://mademistakes.com/so-simple/">So Simple Theme</a>.</span>
<div class="social-icons">
	<a href="http://twitter.com/norbu09" title="Lenz Gschwendtner on Twitter" target="_blank"><i class="icon-twitter icon-2x"></i></a>
	
	
	<a href="http://linkedin.com/in/lenzgschwendtner" title="Lenz Gschwendtner on LinkedIn" target="_blank"><i class="icon-linkedin icon-2x"></i></a>
	
	
	
	<a href="http://github.com/norbu09" title="Lenz Gschwendtner on Github" target="_blank"><i class="icon-github icon-2x"></i></a>
	
</div><!-- /.social-icons -->
  </footer>
</div><!-- /.footer-wrapper -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://lnz.me/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://lnz.me/assets/js/scripts.min.js"></script>

<!-- Jekyll Simple Search option -->
<script>
  $(document).ready(function() {
      $('.search-field').simpleJekyllSearch({
          jsonFile : 'http://lnz.me/search.json',
          searchResults : '.search-results',
          template : '<li><article><a href="{url}">{title} <span class="entry-date"><time datetime="{date}">{shortdate}</time></span></a></article></li>',
          noResults: '<p>Nothing found.</p>'
        });
  });

  (function( $, window, undefined ) {
    
     var bs = {
          close: $(".icon-remove-sign"),
          searchform: $(".search-form"),
          canvas: $("body"),
          dothis: $('.dosearch')
      };
    
    bs.dothis.on('click', function() {
      $('.search-wrapper').css({ display: "block" });
      bs.searchform.toggleClass('active');
      bs.searchform.find('input').focus();
      bs.canvas.toggleClass('search-overlay');
    });
    
      bs.close.on('click', function() {
        $('.search-wrapper').removeAttr( 'style' );
        bs.searchform.toggleClass('active');
        bs.canvas.removeClass('search-overlay');
    });
  })( jQuery, window );
</script>


	        

</body>
</html>
